## NOT TESTED! WRITEN BY AI!
---
# osconfig.yml ‚Äì Server hardening & baseline stack for RHEL¬†10
# -----------------------------------------------------------
# Run with: ansible-playbook -i inventory.ini osconfig.yml
#
# NOTE:
#   ‚Ä¢ All tasks are idempotent ‚Äì run them again and nothing will break.
#   ‚Ä¢ Adjust the variables under `vars:` to match your exact needs.
#   ‚Ä¢ Some steps (e.g. TLS certs, remote rsyslog target) need your own values.
#   ‚Ä¢ Tested on fresh RHEL¬†10 minimal installs.

- name: Baseline server configuration
  hosts: all
  become: true
  vars:
    # ------------------- General -------------------
    common_packages:
      - curl
      - wget
      - vim
      - neovim
      - git
      - btop
      - net-tools
      - cockpit
      - firewalld
      - fail2ban
      - rsync
      - lvm2               # useful for disk mgmt
      - dnf-utils          # for repo management

    # ------------------- Server stack -------------------
    web_server: nginx                 # set to "apache" if you prefer httpd
    php_packages:
      - php
      - php-fpm
      - php-cli
      - php-common
      - php-mysqlnd
      - php-pgsql
    db_engine: mariadb                # set to "postgresql" if you prefer PG
    redis_package: redis

    # ------------------- Users -------------------
    admin_user: sysadmin
    admin_group: sudoers

    # ------------------- SSH hardening -------------------
    ssh_port: 2222
    ssh_permit_root_login: "no"
    ssh_password_authentication: "no"

    # ------------------- Firewall -------------------
    firewall_allowed_ports:
      - "{{ ssh_port }}/tcp"
      - "80/tcp"
      - "443/tcp"
      - "19999/tcp"   # Netdata UI
      - "9090/tcp"    # Cockpit UI

    # ------------------- Logging -------------------
    remote_syslog_host: logs.example.com
    remote_syslog_port: 514

    # ------------------- Backup -------------------
    backup_src: "/etc /var/www /home"
    backup_dest: "/backup"
    backup_retention_days: 30

    # ------------------- Performance tweaks -------------------
    sysctl_params:
      vm.swappiness: 10
      vm.overcommit_memory: 1
      net.core.somaxconn: 65535
      fs.file-max: 2097152

  tasks:

    # ------------------------------------------------------------------
    # 1Ô∏è‚É£ Install base packages + server stack
    # ------------------------------------------------------------------
    - name: Install common utilities
      dnf:
        name: "{{ common_packages }}"
        state: present

    - name: Install web server
      dnf:
        name: "{{ web_server }}"
        state: present

    - name: Install PHP & extensions
      dnf:
        name: "{{ php_packages }}"
        state: present

    - name: Install database engine
      dnf:
        name: "{{ db_engine }}"
        state: present

    - name: Install Redis
      dnf:
        name: "{{ redis_package }}"
        state: present

    # ------------------------------------------------------------------
    # 2Ô∏è‚É£ Firewalld ‚Äì default zones + allow needed ports
    # ------------------------------------------------------------------
    - name: Enable and start firewalld
      service:
        name: firewalld
        state: started
        enabled: true

    - name: Set default zone to public
      command: firewall-cmd --set-default-zone=public
      args:
        warn: false

    - name: Allow essential ports
      firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
        immediate: true
      loop: "{{ firewall_allowed_ports }}"

    - name: Reload firewalld to apply changes
      firewalld:
        state: reloaded

    # ------------------------------------------------------------------
    # 3Ô∏è‚É£ Harden SSH
    # ------------------------------------------------------------------
    - name: Ensure SSH daemon config exists
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^{{ item.key }}'
        line: "{{ item.key }} {{ item.value }}"
        state: present
        create: yes
      loop:
        - { key: 'Port', value: '{{ ssh_port }}' }
        - { key: 'PermitRootLogin', value: '{{ ssh_permit_root_login }}' }
        - { key: 'PasswordAuthentication', value: '{{ ssh_password_authentication }}' }
        - { key: 'PubkeyAuthentication', value: 'yes' }
        - { key: 'ChallengeResponseAuthentication', value: 'no' }

    - name: Restart sshd to apply new settings
      service:
        name: sshd
        state: restarted

    - name: Install fail2ban (already in common_packages) ‚Äì configure jail for ssh
      copy:
        dest: /etc/fail2ban/jail.d/sshd.local
        content: |
          [sshd]
          enabled = true
          port = {{ ssh_port }}
          filter = sshd
          logpath = /var/log/secure
          maxretry = 5
      notify: Restart fail2ban

    # ------------------------------------------------------------------
    # 4Ô∏è‚É£ System user & sudo‚Äëgroup creation
    # ------------------------------------------------------------------
    - name: Ensure admin group exists
      group:
        name: "{{ admin_group }}"
        state: present

    - name: Create admin user with sudo privileges
      user:
        name: "{{ admin_user }}"
        groups: "{{ admin_group }},wheel"
        append: true
        shell: /bin/bash
        create_home: true
        password: "{{ 'ChangeMeNow!' | password_hash('sha512') }}"   # replace ASAP

    - name: Allow admin group passwordless sudo (but keep audit)
      copy:
        dest: /etc/sudoers.d/{{ admin_group }}
        mode: '0440'
        content: "%{{ admin_group }} ALL=(ALL) NOPASSWD: ALL"

    # ------------------------------------------------------------------
    # 5Ô∏è‚É£ Auto‚Äëmount local disks (fstab + systemd)
    # ------------------------------------------------------------------
    - name: Gather block devices
      ansible.builtin.command: lsblk -J -o NAME,FSTYPE,SIZE,MOUNTPOINT,LABEL
      register: blkinfo
      changed_when: false

    - name: Create mount points for unmounted partitions (example /mnt/dataX)
      block:
        - name: Build list of devices needing mount
          set_fact:
            devices_to_mount: >-
              {{
                blkinfo.stdout | from_json |
                json_query('blockdevices[?mountpoint==`null` && fstype!=null].name')
              }}

        - name: Ensure mount directories exist
          file:
            path: "/mnt/{{ item }}"
            state: directory
            owner: root
            group: root
            mode: '0755'
          loop: "{{ devices_to_mount }}"

        - name: Add entries to /etc/fstab
          mount:
            src: "/dev/{{ item }}"
            path: "/mnt/{{ item }}"
            fstype: auto
            opts: defaults,noatime
            state: present
          loop: "{{ devices_to_mount }}"

        - name: Reload systemd daemon (so new fstab entries are seen)
          command: systemctl daemon-reload
          become: true
      when: blkinfo is defined

    # ------------------------------------------------------------------
    # 6Ô∏è‚É£ Basic service hardening (TLS, security headers)
    # ------------------------------------------------------------------
    - name: Install certbot (for Let's Encrypt) ‚Äì only if using nginx
      when: web_server == 'nginx'
      dnf:
        name: python3-certbot-nginx
        state: present

    - name: Generate self‚Äësigned cert (fallback) ‚Äì adjust as needed
      openssl_certificate:
        path: /etc/pki/tls/certs/selfsigned.crt
        privatekey_path: /etc/pki/tls/private/selfsigned.key
        common_name: "{{ inventory_hostname }}"
        provider: selfsigned
      when: web_server == 'nginx'

    - name: Deploy basic security headers for Nginx
      when: web_server == 'nginx'
      blockinfile:
        path: /etc/nginx/conf.d/security.conf
        create: true
        block: |
          add_header X-Content-Type-Options nosniff;
          add_header X-Frame-Options SAMEORIGIN;
          add_header X-XSS-Protection "1; mode=block";
          add_header Referrer-Policy no-referrer-when-downgrade;
          add_header Content-Security-Policy "default-src 'self'";
      notify: Reload nginx

    - name: Ensure nginx runs with TLS (simple example)
      when: web_server == 'nginx'
      template:
        src: nginx_default_ssl.j2
        dest: /etc/nginx/conf.d/default-ssl.conf
      notify: Reload nginx

    # ------------------------------------------------------------------
    # 7Ô∏è‚É£ Install & start Netdata monitoring
    # ------------------------------------------------------------------
    - name: Install Netdata (official script)
      shell: |
        bash <(curl -Ss https://my-netdata.io/kickstart.sh) --dont-wait
      args:
        creates: /usr/libexec/netdata/plugins.d

    - name: Ensure Netdata service is enabled
      service:
        name: netdata
        state: started
        enabled: true

    # ------------------------------------------------------------------
    # 8Ô∏è‚É£ Centralised logging ‚Äì forward to remote rsyslog
    # ------------------------------------------------------------------
    - name: Install rsyslog (should already be present)
      dnf:
        name: rsyslog
        state: present

    - name: Configure remote syslog forwarding
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: '^*.* @'
        line: "*.* @@{{ remote_syslog_host }}:{{ remote_syslog_port }}"
        state: present
        insertafter: EOF
      notify: Restart rsyslog

    # ------------------------------------------------------------------
    # 9Ô∏è‚É£ Daily backup schedule (rsync + snapshot via cron)
    # ------------------------------------------------------------------
    - name: Ensure backup destination exists
      file:
        path: "{{ backup_dest }}"
        state: directory
        owner: root
        group: root
        mode: '0750'

    - name: Install backup script
      copy:
        dest: /usr/local/bin/daily_backup.sh
        mode: '0750'
        content: |
          #!/bin/bash
          set -euo pipefail
          DATE=$(date +%Y-%m-%d)
          SNAPSHOT="{{ backup_dest }}/snapshots/${DATE}"
          mkdir -p "${SNAPSHOT}"
          rsync -aAXv --delete {{ backup_src }} "${SNAPSHOT}"
          # Prune old snapshots
          find "{{ backup_dest }}/snapshots" -maxdepth 1 -type d -mtime +{{ backup_retention_days }} -exec rm -rf {} +

    - name: Add daily cron job for backups
      cron:
        name: "Daily rsync snapshot backup"
        minute: "30"
        hour: "2"
        job: "/usr/local/bin/daily_backup.sh >> /var/log/daily_backup.log 2>&1"

    # ------------------------------------------------------------------
    # üîß Performance tweaks ‚Äì sysctl
    # ------------------------------------------------------------------
    - name: Apply sysctl parameters
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop: "{{ sysctl_params|dict2items }}"

  handlers:
    - name: Restart fail2ban
      service:
        name: fail2ban
        state: restarted

    - name: Reload nginx
      service:
        name: nginx
        state: reloaded

    - name: Restart rsyslog
      service:
        name: rsyslog
        state: restarted
